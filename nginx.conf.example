worker_processes  1;
error_log  logs/error.log  debug;
events {
    worker_connections  1024;
}

# Redisレートリミットモジュールをロード
load_module modules/libngx_ratelimit_redis.so;

http {
    server {
        listen 8080;
        server_name localhost;

        # すべてのIPアドレスに対して、毎秒10リクエストまで許可（バースト5）
        # デフォルトアルゴリズム: スライディングウィンドウ
        location / {
            # モジュールを有効化し、オプションを設定
            ratelimit_redis on redis_url=redis://127.0.0.1:6379 key=remote_addr rate=10 burst=5;

            # レート制限に引っかかった場合、403 Forbiddenを返し、
            # それ以外の場合は次のハンドラに処理を渡す

            # 他のディレクティブ...
            root html;
            index index.html index.htm;
        }

        # 固定ウィンドウアルゴリズムを使用したレート制限
        location /fixed {
            ratelimit_redis on redis_url=redis://127.0.0.1:6379 key=remote_addr rate=10 burst=5 algorithm=fixed_window window_size=60;

            # ハンドラ処理...
            return 200 "Fixed Window Algorithm";
        }

        # トークンバケットアルゴリズムを使用したレート制限
        location /token {
            ratelimit_redis on redis_url=redis://127.0.0.1:6379 key=remote_addr rate=10 burst=20 algorithm=token_bucket;

            # ハンドラ処理...
            return 200 "Token Bucket Algorithm";
        }

        # リーキーバケットアルゴリズムを使用したレート制限
        location /leaky {
            ratelimit_redis on redis_url=redis://127.0.0.1:6379 key=remote_addr rate=5 burst=10 algorithm=leaky_bucket;

            # ハンドラ処理...
            return 200 "Leaky Bucket Algorithm";
        }

        # スライディングウィンドウアルゴリズムを明示的に使用
        location /sliding {
            ratelimit_redis on redis_url=redis://127.0.0.1:6379 key=remote_addr rate=15 burst=5 algorithm=sliding_window window_size=30;

            # ハンドラ処理...
            return 200 "Sliding Window Algorithm";
        }

        # APIキーを使用したレート制限の例
        location /api {
            # APIキーを使用したレート制限（X-API-Keyヘッダー）
            # 毎秒5リクエストまで許可（バースト2）
            ratelimit_redis on redis_url=redis://127.0.0.1:6379 key=http_x_api_key rate=5 burst=2;

            # ハンドラ処理...
            return 200 "API Response";
        }

        # 特定のパスに対してレート制限しない例
        location /static {
            # レート制限を無効化
            ratelimit_redis off;

            # 静的ファイルの処理...
            alias /path/to/static;
        }
    }
}
